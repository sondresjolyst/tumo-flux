apiVersion: batch/v1
kind: Job
metadata:
  name: vault-transit-bootstrap
  namespace: vault-transit
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: bootstrap
          image: hashicorp/vault:1.19.0
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "â³ Waiting for Vault to respond at $VAULT_ADDR..."
              until curl -s "$VAULT_ADDR/v1/sys/health" | grep '"initialized": false'; do
                echo "Waiting..." && sleep 2
              done

              echo "ðŸ” Initializing Vault..."
              vault operator init -format=json -key-shares=5 -key-threshold=3 > /tmp/init.json
              cat /tmp/init.json

              echo "ðŸ”“ Unsealing Vault..."
              for i in 0 1 2; do
                key=$(jq -r ".unseal_keys_b64[$i]" /tmp/init.json)
                vault operator unseal "$key"
              done

              export VAULT_TOKEN=$(jq -r ".root_token" /tmp/init.json)

              echo "ðŸš€ Enabling Transit..."
              vault secrets enable transit

              echo "ðŸ”‘ Creating Transit Key..."
              vault write -f transit/keys/autounseal

              echo "ðŸ“œ Writing policy..."
              vault policy write autounseal - <<EOF
                path "transit/encrypt/autounseal" {
                  capabilities = ["update"]
                }
                path "transit/decrypt/autounseal" {
                  capabilities = ["update"]
                }
              EOF

              echo "ðŸŽ« Creating token..."
              TOKEN=$(vault token create -policy=autounseal -period=8760h -format=json | jq -r '.auth.client_token')

              echo "ðŸ“¦ Creating token secret in vault namespace..."
              kubectl create ns vault --dry-run=client -o yaml | kubectl apply -f -
              kubectl delete secret vault-b-unseal-token -n vault --ignore-not-found
              kubectl create secret generic vault-b-unseal-token -n vault --from-literal=token="$TOKEN"

              echo "âœ… Bootstrap complete"
          env:
            - name: VAULT_ADDR
              value: http://vault.vault-transit.svc:8200
